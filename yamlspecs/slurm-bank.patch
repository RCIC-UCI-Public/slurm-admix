diff '--context=6' --recursive slurm-bank-1.4.2/src/_sbank-balance.pl slurm-bank-1.4.2-new/src/_sbank-balance.pl
*** slurm-bank-1.4.2/src/_sbank-balance.pl	2023-02-16 10:14:25.605710561 -0800
--- slurm-bank-1.4.2-new/src/_sbank-balance.pl	2023-02-16 14:10:51.713056672 -0800
***************
*** 435,461 ****
  # run sacctmgr to find all Account limits from the list of 
  # Assocations
  # note that gives us the current active Accounts, which is useful
  # because sreport will show usage from deleted accounts
  #####################################################################
  
! open (SACCTMGR, "sacctmgr list association cluster=$clustername format='Account,GrpCPUMins'" .
  		" -p -n |")
  	or die "$0: Unable to run sacctmgr: $!\n";
  
  # GrpCPUMins are not in 'sreport'
  while (<SACCTMGR>) {
! 	# format is "acct_string|nnnn|" where nnnn is the number of GrpCPUMins allocated
! 	if (/^([^|]+)\|([^|]*)/) {
! 		if ($2 ne "" && !exists($acc_limits{"\U$1"})) {
! 			$acc_limits{"\U$1"} = sprintf("%.0f", $2); # normalise account names to uppercase
! 		} elsif (!exists($acc_limits{"\U$1"})) {
! 			# store all accounts, even those without GrpCPUMins allocated, so we can report usage
! 			$acc_limits{"\U$1"} = 0; # normalise account names to uppercase
! 		}
! 	}
  
  }
  
  close(SACCTMGR);
  
  
--- 435,466 ----
  # run sacctmgr to find all Account limits from the list of 
  # Assocations
  # note that gives us the current active Accounts, which is useful
  # because sreport will show usage from deleted accounts
  #####################################################################
  
! open (SACCTMGR, "sacctmgr list association cluster=$clustername format='Account,User,GrpCPUMins'" .
  		" -p -n |")
  	or die "$0: Unable to run sacctmgr: $!\n";
  
  # GrpCPUMins are not in 'sreport'
  while (<SACCTMGR>) {
!         # format is "acct_string|user|nnnn|" where nnnn is the number of GrpCPUMins allocated
!         my @fields=split('\|',$_);
!         my $acct = $fields[0];
!         my $user = $fields[1];
!         my $sus = $fields[2];
!         if ($#fields == 3) {
!                 # want just the account allocation, limits on users are ignored
!                 if ($sus ne "" && $user eq "") {
!                         $acc_limits{"\U$acct"} = sprintf("%.0f", $sus); # normalise account names to uppercase
!                 } elsif (!exists($acc_limits{"\U$acct"})) {
!                         # store all accounts, even those without GrpCPUMins allocated, so we can report usage
!                         $acc_limits{"\U$acct"} = 0; # normalise account names to uppercase
!                 }
!         }
  
  }
  
  close(SACCTMGR);
  
  
